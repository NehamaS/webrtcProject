# mcu-metrics

![npm](https://img.shields.io/npm/v/mcu-metrics.svg) ![license](https://img.shields.io/npm/l/mcu-metrics.svg) ![github-issues](https://img.shields.io/github/issues/ssh://git@at.mavenir.com:7999/mcu/mcu-metrics.git.svg) ![Circle CI build status](https://circleci.com/gh/ssh://git@at.mavenir.com:7999/mcu/mcu-metrics.git.svg?style=svg)

mMCU Prometheus metrics client

![nodei.co](https://nodei.co/npm/mcu-metrics.png?downloads=true&downloadRank=true&stars=true)

![travis-status](https://img.shields.io/travis/ssh://git@at.mavenir.com:7999/mcu/mcu-metrics.git.svg)
![stars](https://img.shields.io/github/stars/ssh://git@at.mavenir.com:7999/mcu/mcu-metrics.git.svg)
![forks](https://img.shields.io/github/forks/ssh://git@at.mavenir.com:7999/mcu/mcu-metrics.git.svg)

![forks](https://img.shields.io/github/forks/ssh://git@at.mavenir.com:7999/mcu/mcu-metrics.git.svg)

![](https://david-dm.org/ssh://git@at.mavenir.com:7999/mcu/mcu-metrics.git/status.svg)
![](https://david-dm.org/ssh://git@at.mavenir.com:7999/mcu/mcu-metrics.git/dev-status.svg)

## Install

`npm install --save mcu-metrics`

## Scripts

- **npm run build** : `tsc`
- **npm run start** : `npm run build && node build/index.js`
- **npm run lint** : `eslint . --ext .ts`
- **npm run test** : `jest`
- **npm run test:dev** : `jest --watchAll`
- **npm run readme** : `node ./node_modules/.bin/node-readme`

## Dependencies

| Package                                                                                            |  Version  | Dev |
| -------------------------------------------------------------------------------------------------- | :-------: | :-: |
| [eslint-plugin-jest](https://www.npmjs.com/package/eslint-plugin-jest)                             |  ^24.1.0  |  ✖  |
| [jest](https://www.npmjs.com/package/jest)                                                         |  ^26.5.3  |  ✖  |
| [mcu-persitence-service](https://www.npmjs.com/package/mcu-persitence-service)                     |  ^1.0.28  |  ✖  |
| [prom-client](https://www.npmjs.com/package/prom-client)                                           |  ^12.0.0  |  ✖  |
| [ts-jest](https://www.npmjs.com/package/ts-jest)                                                   |  ^26.4.1  |  ✖  |
| [@types/jest](https://www.npmjs.com/package/@types/jest)                                           | ^26.0.14  |  ✔  |
| [@types/node](https://www.npmjs.com/package/@types/node)                                           | ^14.14.10 |  ✔  |
| [@typescript-eslint/eslint-plugin](https://www.npmjs.com/package/@typescript-eslint/eslint-plugin) |  ^4.8.2   |  ✔  |
| [@typescript-eslint/parser](https://www.npmjs.com/package/@typescript-eslint/parser)               |  ^4.8.2   |  ✔  |
| [eslint](https://www.npmjs.com/package/eslint)                                                     |  ^7.14.0  |  ✔  |
| [eslint-config-prettier](https://www.npmjs.com/package/eslint-config-prettier)                     |  ^6.10.0  |  ✔  |
| [eslint-plugin-prettier](https://www.npmjs.com/package/eslint-plugin-prettier)                     |  ^3.1.2   |  ✔  |
| [node-readme](https://www.npmjs.com/package/node-readme)                                           |  ^0.1.9   |  ✔  |
| [onchange](https://www.npmjs.com/package/onchange)                                                 |  ^7.1.0   |  ✔  |
| [prettier](https://www.npmjs.com/package/prettier)                                                 |  ^2.2.0   |  ✔  |
| [run-script-os](https://www.npmjs.com/package/run-script-os)                                       |  ^1.1.1   |  ✔  |
| [ts-node](https://www.npmjs.com/package/ts-node)                                                   |  ^9.0.0   |  ✔  |
| [typescript](https://www.npmjs.com/package/typescript)                                             |  ^4.0.3   |  ✔  |

## Usage

```javascript
const { Counter } = require('./index');

const counter = new Counter({
  name: 'metric_name', // name of the metric to use for prometheus
  help: 'metric_help', // help description of what metric means
  labelNames: ['method', 'statusCode'], // labels you will use for this counter
});

const defaultLabels = { serviceName: 'api-v1' }; // Default Labels - If you want to add labels to all of the metrics
register.setDefaultLabels(defaultLabels);

(async () => {
  await counter.set({ method: 'GET', statusCode: '200' }, 10); // Set to 10
  await counter.inc({ method: 'GET', statusCode: '200' }, 10); // Increment 1
  await counter.inc({ method: 'GET', statusCode: '200' }, 10); // Increment 10
  await counter.dec({ method: 'GET', statusCode: '200' }); // Decrement by 1
  await counter.dec({ method: 'GET', statusCode: '200' }, 10); // Decrement by 10
})();
```

## Usage with service db (mcu-persistence-service)

```javascript
const logger = (global as any).logger || console;
const { Counter } = require('mcu-metrics');
const {
  PersistFactory,
} = require('mcu-persitence-service/persistance/persistFactory');
const dbTypes = require('mcu-persitence-service/common/common');

const options = {};
options.type = dbTypes.DBType.INMEM;
options.prefix = 'MEDIA-TEST';

const factory = new PersistFactory(logger, options);
const db = factory.getDB();

global.db = db;

(async () => {
  const counter = new Counter({
    name: 'metric_name',
    help: 'metric_help',
    labelNames: ['method', 'statusCode'],
  });

  await counter.set({ method: 'GET', statusCode: '200' }, 10);
  await counter.inc({ method: 'GET', statusCode: '200' }, 10);
  await counter.inc({ method: 'GET', statusCode: '200' }, 10);
  await counter.dec({ method: 'GET', statusCode: '200' }, 2);
  const output = await counter.metrics();
  console.log(output);
})();
```
